# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'search_and_delete.ui'
#
# Created by: PyQt5 UI code generator 5.13.0
#
# WARNING! All changes made in this file will be lost!


from PyQt5 import QtCore, QtGui, QtWidgets


class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(1247, 838)
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.lineEdit = QtWidgets.QLineEdit(self.centralwidget)
        self.lineEdit.setGeometry(QtCore.QRect(150, 40, 151, 21))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.lineEdit.setFont(font)
        self.lineEdit.setObjectName("lineEdit")
        self.comboBox = QtWidgets.QComboBox(self.centralwidget)
        self.comboBox.setGeometry(QtCore.QRect(150, 90, 151, 21))
        font = QtGui.QFont()
        font.setFamily("黑体")
        font.setPointSize(9)
        font.setBold(False)
        font.setWeight(50)
        self.comboBox.setFont(font)
        self.comboBox.setObjectName("comboBox")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.comboBox.addItem("")
        self.textBrowser = QtWidgets.QTextBrowser(self.centralwidget)
        self.textBrowser.setGeometry(QtCore.QRect(50, 140, 531, 551))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.textBrowser.setFont(font)
        self.textBrowser.setObjectName("textBrowser")
        self.pushButton = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton.setGeometry(QtCore.QRect(50, 710, 93, 28))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.pushButton.setFont(font)
        self.pushButton.setObjectName("pushButton")
        self.pushButton_2 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_2.setGeometry(QtCore.QRect(710, 710, 93, 28))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.pushButton_2.setFont(font)
        self.pushButton_2.setObjectName("pushButton_2")
        self.radioButton = QtWidgets.QRadioButton(self.centralwidget)
        self.radioButton.setGeometry(QtCore.QRect(40, 40, 101, 21))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.radioButton.setFont(font)
        self.radioButton.setObjectName("radioButton")
        self.radioButton_2 = QtWidgets.QRadioButton(self.centralwidget)
        self.radioButton_2.setGeometry(QtCore.QRect(40, 90, 101, 20))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.radioButton_2.setFont(font)
        self.radioButton_2.setObjectName("radioButton_2")
        self.radioButton_3 = QtWidgets.QRadioButton(self.centralwidget)
        self.radioButton_3.setGeometry(QtCore.QRect(590, 30, 171, 61))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.radioButton_3.setFont(font)
        self.radioButton_3.setObjectName("radioButton_3")
        self.textEdit = QtWidgets.QTextEdit(self.centralwidget)
        self.textEdit.setGeometry(QtCore.QRect(630, 140, 341, 551))
        font = QtGui.QFont()
        font.setFamily("宋体")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.textEdit.setFont(font)
        self.textEdit.setObjectName("textEdit")
        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setGeometry(QtCore.QRect(770, 50, 51, 20))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.label.setFont(font)
        self.label.setObjectName("label")
        self.dateEdit = QtWidgets.QDateEdit(self.centralwidget)
        self.dateEdit.setGeometry(QtCore.QRect(860, 100, 110, 22))
        self.dateEdit.setObjectName("dateEdit")
        self.lineEdit_2 = QtWidgets.QLineEdit(self.centralwidget)
        self.lineEdit_2.setGeometry(QtCore.QRect(820, 50, 151, 21))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.lineEdit_2.setFont(font)
        self.lineEdit_2.setObjectName("lineEdit_2")
        self.label_2 = QtWidgets.QLabel(self.centralwidget)
        self.label_2.setGeometry(QtCore.QRect(800, 100, 51, 20))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.label_2.setFont(font)
        self.label_2.setObjectName("label_2")
        self.comboBox_2 = QtWidgets.QComboBox(self.centralwidget)
        self.comboBox_2.setGeometry(QtCore.QRect(640, 100, 151, 21))
        font = QtGui.QFont()
        font.setFamily("黑体")
        font.setPointSize(9)
        font.setBold(False)
        font.setWeight(50)
        self.comboBox_2.setFont(font)
        self.comboBox_2.setObjectName("comboBox_2")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.comboBox_2.addItem("")
        self.label_3 = QtWidgets.QLabel(self.centralwidget)
        self.label_3.setGeometry(QtCore.QRect(590, 100, 51, 20))
        font = QtGui.QFont()
        font.setFamily("微软雅黑")
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(75)
        self.label_3.setFont(font)
        self.label_3.setObjectName("label_3")
        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 1247, 26))
        self.menubar.setObjectName("menubar")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)
        self.pushButton.clicked.connect(MainWindow.p1_ck)
        self.pushButton_2.clicked.connect(MainWindow.p2_ck)
        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))
        self.comboBox.setItemText(0, _translate("MainWindow", "颈椎病"))
        self.comboBox.setItemText(1, _translate("MainWindow", "格林巴利综合征"))
        self.comboBox.setItemText(2, _translate("MainWindow", "肩周炎"))
        self.comboBox.setItemText(3, _translate("MainWindow", "面瘫"))
        self.comboBox.setItemText(4, _translate("MainWindow", "颞下颌关节痛"))
        self.comboBox.setItemText(5, _translate("MainWindow", "髋关节疾病"))
        self.comboBox.setItemText(6, _translate("MainWindow", "前列腺疾病"))
        self.comboBox.setItemText(7, _translate("MainWindow", "中风后遗症"))
        self.comboBox.setItemText(8, _translate("MainWindow", "网球肘"))
        self.comboBox.setItemText(9, _translate("MainWindow", "肠疾"))
        self.comboBox.setItemText(10, _translate("MainWindow", "腓总神经损伤"))
        self.comboBox.setItemText(11, _translate("MainWindow", "膝关节痛"))
        self.comboBox.setItemText(12, _translate("MainWindow", "足跟痛"))
        self.comboBox.setItemText(13, _translate("MainWindow", "腕关节疼痛"))
        self.comboBox.setItemText(14, _translate("MainWindow", "腰椎间盘突出"))
        self.comboBox.setItemText(15, _translate("MainWindow", "颞下颌关节痛"))
        self.comboBox.setItemText(16, _translate("MainWindow", "踝关节痛"))
        self.comboBox.setItemText(17, _translate("MainWindow", "胸椎疾病"))
        self.comboBox.setItemText(18, _translate("MainWindow", "腰痛"))
        self.comboBox.setItemText(19, _translate("MainWindow", "脑瘫"))
        self.comboBox.setItemText(20,_translate('MainWindow',"其他疾病与症状"))
        self.pushButton.setText(_translate("MainWindow", "查找"))
        self.pushButton_2.setText(_translate("MainWindow", "提交"))
        self.radioButton.setText(_translate("MainWindow", "查找姓名"))
        self.radioButton_2.setText(_translate("MainWindow", "查找病症"))
        self.radioButton_3.setText(_translate("MainWindow", "补充写入治疗过程"))
        self.label.setText(_translate("MainWindow", "姓名："))
        self.label_2.setText(_translate("MainWindow", "时间："))
        self.comboBox_2.setItemText(0, _translate("MainWindow", "颈椎病"))
        self.comboBox_2.setItemText(1, _translate("MainWindow", "格林巴利综合征"))
        self.comboBox_2.setItemText(2, _translate("MainWindow", "肩周炎"))
        self.comboBox_2.setItemText(3, _translate("MainWindow", "面瘫"))
        self.comboBox_2.setItemText(4, _translate("MainWindow", "颞下颌关节痛"))
        self.comboBox_2.setItemText(5, _translate("MainWindow", "髋关节疾病"))
        self.comboBox_2.setItemText(6, _translate("MainWindow", "前列腺疾病"))
        self.comboBox_2.setItemText(7, _translate("MainWindow", "中风后遗症"))
        self.comboBox_2.setItemText(8, _translate("MainWindow", "网球肘"))
        self.comboBox_2.setItemText(9, _translate("MainWindow", "肠疾"))
        self.comboBox_2.setItemText(10, _translate("MainWindow", "腓总神经损伤"))
        self.comboBox_2.setItemText(11, _translate("MainWindow", "膝关节痛"))
        self.comboBox_2.setItemText(12, _translate("MainWindow", "足跟痛"))
        self.comboBox_2.setItemText(13, _translate("MainWindow", "腕关节疼痛"))
        self.comboBox_2.setItemText(14, _translate("MainWindow", "腰椎间盘突出"))
        self.comboBox_2.setItemText(15, _translate("MainWindow", "颞下颌关节痛"))
        self.comboBox_2.setItemText(16, _translate("MainWindow", "踝关节痛"))
        self.comboBox_2.setItemText(17, _translate("MainWindow", "胸椎疾病"))
        self.comboBox_2.setItemText(18, _translate("MainWindow", "腰痛"))
        self.comboBox_2.setItemText(19, _translate("MainWindow", "脑瘫"))
        self.comboBox_2.setItemText(20,_translate("MainWindow","其他疾病与症状"))
        self.label_3.setText(_translate("MainWindow", "病症："))

import sys

from PyQt5 import QtWidgets, QtGui
from numpy import load,save,where
from os import listdir,remove
from pandas import read_csv,DataFrame
def time_is_in_interval(time1,time2,time_for_check_original):
    time1_split=[int(i) for i in time1.split("/")]
    time2_split=[int(i) for i in time2.split("/")]
    time_for_check=[int(i) for i in time_for_check_original.split("/")]
    if time_for_check[0]<=time2_split[0] and time_for_check[0]>=time1_split[0]:
        if time_for_check[1]<=time2_split[1] and time_for_check[1]>=time1_split[1]:
            if time_for_check[2] <= time2_split[2] and time_for_check[2] >= time1_split[2]:
                return True
            else:
                return False
        else:
            return False
    else:
        return False

filename_list=listdir("./database/")
class Mywindow(QtWidgets.QMainWindow,Ui_MainWindow):
    def __init__(self,parent = None):
        # super(Mywindow, self).__init__()
        QtWidgets.QMainWindow.__init__(self,parent)
        self.use_palette()
        self.setupUi(self)
        self.info=""
        self.relations = dict(load("recorded_data.npy", allow_pickle=True).item())
    def use_palette(self):
        self.setWindowTitle("设置背景图片")
        window_pale = QtGui.QPalette()
        window_pale.setBrush(self.backgroundRole(), QtGui.QBrush(QtGui.QPixmap("./timg2.jpg")))
        self.setPalette(window_pale)
    def closeEvent(self, event):
        reply = QtWidgets.QMessageBox.question(self, '信息', '确认退出吗？',QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No, QtWidgets.QMessageBox.No)
        if reply == QtWidgets.QMessageBox.Yes:
            event.accept()
        else:
            event.ignore()
    def p1_ck(self):
        if self.radioButton.isChecked():
            self.textBrowser.clear()
            name=self.lineEdit.text().strip()
            name2disease=load("recorded_data.npy",allow_pickle=True)[0]
            print(name2disease)
            self.textBrowser.append("姓名: " + name)
            self.textBrowser.append("-*"*61)

            if name2disease.get(name):
                diseases=name2disease[name]

                for disease in diseases:
                    filename="./database/"+disease+".csv"
                    data=read_csv(filename,encoding='gb18030')
                    data=DataFrame(data)
                    result=data[data.iloc[:,2]==name]
                    self.textBrowser.append("*" * 50)
                    self.textBrowser.append("*"*50)
                    self.textBrowser.append("[疾病类目]===>>>[["+disease+"]]")
                    self.textBrowser.append("*" * 50)
                    self.textBrowser.append("*" * 50)
                    self.textBrowser.append("[年龄]: " + str(result.iloc[0, 3]))
                    self.textBrowser.append("[性别]: " + str(result.iloc[0, 4]))
                    self.textBrowser.append("[职业]: " + str(result.iloc[0, 5]))
                    self.textBrowser.append("[联系方式]: " + str(result.iloc[0, 6]))
                    times_count=0
                    period_num=0

                    for row in range(len(result)):
                        self.textBrowser.append("-" * 30)
                        self.textBrowser.append("[时间]: "+result.iloc[row,1])
                        self.textBrowser.append("[疗程]: " + result.iloc[row, 8])
                        try:
                            self.textBrowser.append("[血压]: " + result.iloc[row, 7])
                        except:
                            self.textBrowser.append("[血压]: " + '')


#如果不选择其他疾病与症状，那么，我们就列出其所有可以被check的病症，
                        if self.comboBox.currentIndex()!=20:
                            symptoms=data.iloc[0, list(where(result.iloc[row,:] == '1'))[0]].values
                            for id,sym in enumerate(symptoms):
                                self.textBrowser.append("[症状{0}]:  {1}".format(id+1,sym))

                        self.textBrowser.append("[状态]："+result.iloc[row, 9])
                        try:
                            txt_=result.iloc[row,-1]
                            self.textBrowser.append("[诊疗过程]： " + txt_)
                        except:
                            txt_=''
                            self.textBrowser.append("[诊疗过程]： " + txt_)
                        if result.iloc[row,9]=="治愈" or result.iloc[row,9]=="无效" or result.iloc[row,9]=="疗程结束":
                            period_num += (times_count+1)
                            times_count=0
                        elif result.iloc[row,9]=="该患者同时患有的疾病":
                            pass
                        else:
                            times_count+=1
                    if len(result)!=period_num:
                        current_liaocheng = len(result) - period_num
                    else:
                        current_liaocheng = "疗程结束"
                    if result.iloc[-1,9]=="该患者同时患有的疾病":
                        current_liaocheng="该患者同时患有的疾病"
                    self.textBrowser.append("[INFO]===>>【当前疗程进度】:{0}/{1}".format(str(current_liaocheng), result.iloc[len(result)-1, 8]))

            else:
                self.textBrowser.append("信息不存在")
        elif self.radioButton_2.isChecked():
            self.textBrowser.clear()
            the_disease=self.comboBox.currentText()
            the_filename = "./database/" + the_disease + ".csv"
            data_ = read_csv(the_filename, encoding='gb18030')
            effective=sum((data_.iloc[:,9]=="有效").values)
            no_effect=sum((data_.iloc[:,9]=="无效").values)
            cured=sum((data_.iloc[:,9]=="治愈").values)
            continue_treatment=sum((data_.iloc[:,9]=="继续临床观察").values)
            finished_treatment=sum((data_.iloc[:,9]=="疗程结束").values)
            summs=effective+no_effect+cured
            self.textBrowser.append("有效比例: " +str(effective/summs))
            self.textBrowser.append("无效比例: " + str(no_effect / summs))
            self.textBrowser.append("治愈比例: " + str(cured / summs))
            self.textBrowser.append("在观察比例："+str(continue_treatment/summs))
            self.textBrowser.append("疗程结束比例："+str(finished_treatment/summs))
        else:
            self.textBrowser.append("[Info] 没有勾选查询模式")

    def p2_ck(self):
        reply = QtWidgets.QMessageBox.question(self,
                                               "温馨提示",
                                               "是否确认提交？",
                                               QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
                                               QtWidgets.QMessageBox.No)
        if self.radioButton_3.isChecked():
            text=self.textEdit.toPlainText()
            times=self.dateEdit.text()
            name=self.lineEdit_2.text()
            disease_=self.comboBox_2.currentText()
            data_filepath="./database/" + disease_ + ".csv"
            datas = read_csv(data_filepath, encoding='gb18030')

            for id,date in enumerate(list(datas.iloc[:,1].values)):
                times_list=times.split('/')
                condition=True
                try:
                    date_list=times.split('-')[:3]
                except:
                    date_list=['','','']
                for times_item,date_item in zip(times_list,date_list):
                    if times_item in date_item:
                        condition=condition and True
                    else:
                        condition=condition and False

                if condition and datas.iloc[id,2]==name:
                    datas.iloc[id,-1]=str(text)
            remove(data_filepath)
            datas.to_csv(data_filepath,encoding="gb18030",index=False)
            self.textBrowser.append("[Info] 提交成功！")
        else:
            self.textBrowser.append("[Info] 没有勾选补充书写模式")




app = QtWidgets.QApplication(sys.argv)
window = Mywindow()

window.resize(1000, 800)
window.show()
sys.exit(app.exec_())
